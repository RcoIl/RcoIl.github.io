<?xml version="1.0" encoding="utf-8" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN" "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd"><svg xmlns="http://www.w3.org/2000/svg" width="1595" height="1299" xmlns:xlink="http://www.w3.org/1999/xlink"><source><![CDATA[Title: Cobalt Strike 的 External C2

Teamserver-->External C2: 
External C2-->Controller: 
External C2->External C2: 启用 externalc2_start(ip,port)
Controller-->>External C2: Socket 连接 C2，并发送配置进行请求 Payload Stage
External C2-->>Controller: 发送 Payload Stage
Controller->Controller: 启用新的 Socket，等待 Client (EXE) 连接
Client (EXE)-->>Controller: 连接请求
Controller-->>Client (EXE): 将 Payload Stage 中继给 Client (EXE)
Client (EXE)-->>SMB Beacon: 利用进程注入技术将 Payload Stage 注入到进程中
SMB Beacon->SMB Beacon: 启用命名管道
Client (EXE)-->>SMB Beacon: 连接命名管道，用于结果及命令的收发
SMB Beacon-->>Client (EXE): 发送 Metadata
Client (EXE)-->>Controller: 中继 Metadata
Controller-->>External C2: 发送 Metadata
External C2 ->External C2: 处理 Metadata
Teamserver->Teamserver: 出现新会话
Teamserver-->External C2: 下发任务
External C2-->>Controller: 发送所下发任务
Controller-->>Client (EXE): 中继下发任务
Client (EXE)-->>SMB Beacon: 发送下发任务
SMB Beacon->SMB Beacon: 处理任务
SMB Beacon-->>Client (EXE): 返回任务处理结果
Client (EXE)-->>Controller: 中继返回任务处理结果
Controller-->>External C2: 发送返回任务处理结果
External C2-->>Teamserver: 处理返回结果，并显示
Teamserver-->>SMB Beacon: 退出请求
SMB Beacon->SMB Beacon: 退出
Client (EXE)-->>SMB Beacon: 命名管道读取出错
Client (EXE)-->>Controller: 反馈命名管道读取出错，会话退出
Controller-->>External C2: 断开连接]]></source><desc>Cobalt Strike 的 External C2</desc><defs><marker viewBox="0 0 5 5" markerWidth="5" markerHeight="5" orient="auto" refX="5" refY="2.5" id="markerArrowBlock"><path d="M 0 0 L 5 2.5 L 0 5 z"></path></marker><marker viewBox="0 0 9.6 16" markerWidth="4" markerHeight="16" orient="auto" refX="9.6" refY="8" id="markerArrowOpen"><path d="M 9.6,8 1.92,16 0,13.7 5.76,8 0,2.286 1.92,0 9.6,8 z"></path></marker></defs><g class="title"><rect x="10" y="10" width="254.921875" height="29" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="15" y="30" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="15">Cobalt Strike 的 External C2</tspan></text></g><g class="actor"><rect x="10" y="49" width="108.171875" height="39" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="20" y="74" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="20">Teamserver</tspan></text></g><g class="actor"><rect x="10" y="1240" width="108.171875" height="39" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="20" y="1265" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="20">Teamserver</tspan></text></g><line x1="64.0859375" x2="64.0859375" y1="88" y2="1240" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="185.6015625" y="49" width="116.96875" height="39" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="195.6015625" y="74" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="195.6015625">External C2</tspan></text></g><g class="actor"><rect x="185.6015625" y="1240" width="116.96875" height="39" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="195.6015625" y="1265" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="195.6015625">External C2</tspan></text></g><line x1="244.0859375" x2="244.0859375" y1="88" y2="1240" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="613.328125" y="49" width="108.171875" height="39" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="623.328125" y="74" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="623.328125">Controller</tspan></text></g><g class="actor"><rect x="613.328125" y="1240" width="108.171875" height="39" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="623.328125" y="1265" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="623.328125">Controller</tspan></text></g><line x1="667.4140625" x2="667.4140625" y1="88" y2="1240" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="946.9765625" y="49" width="72.78125" height="39" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="956.9765625" y="74" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="956.9765625">Client (EXE)</tspan></text></g><g class="actor"><rect x="946.9765625" y="1240" width="72.78125" height="39" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="956.9765625" y="1265" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="956.9765625">Client (EXE)</tspan></text></g><line x1="983.3671875" x2="983.3671875" y1="88" y2="1240" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="1321.3359375" y="49" width="107.96875" height="39" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="1331.3359375" y="74" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1331.3359375">SMB Beacon</tspan></text></g><g class="actor"><rect x="1321.3359375" y="1240" width="107.96875" height="39" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="1331.3359375" y="1265" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1331.3359375">SMB Beacon</tspan></text></g><line x1="1375.3203125" x2="1375.3203125" y1="88" y2="1240" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="signal"><text x="154.0859375" y="113" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="154.0859375"></tspan></text><line x1="64.0859375" x2="244.0859375" y1="108" y2="108" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="455.75" y="133" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="455.75"></tspan></text><line x1="244.0859375" x2="667.4140625" y1="128" y2="128" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="269.0859375" y="162.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="269.0859375">启用 externalc2_start(ip,port)</tspan></text><line x1="244.0859375" x2="264.0859375" y1="148" y2="148" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="264.0859375" x2="264.0859375" y1="148" y2="172" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="264.0859375" x2="244.0859375" y1="172" y2="172" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="254.0859375" y="197.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="254.0859375">Socket 连接 C2，并发送配置进行请求 Payload Stage</tspan></text><line x1="667.4140625" x2="244.0859375" y1="206" y2="206" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="378.0703125" y="236.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="378.0703125">发送 Payload Stage</tspan></text><line x1="244.0859375" x2="667.4140625" y1="245" y2="245" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="692.4140625" y="279.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="692.4140625">启用新的 Socket，等待 Client (EXE) 连接</tspan></text><line x1="667.4140625" x2="687.4140625" y1="265" y2="265" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="687.4140625" x2="687.4140625" y1="265" y2="289" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="687.4140625" x2="667.4140625" y1="289" y2="289" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="793.390625" y="314.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="793.390625">连接请求</tspan></text><line x1="983.3671875" x2="667.4140625" y1="323" y2="323" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="696.625" y="353.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="696.625">将 Payload Stage 中继给 Client (EXE)</tspan></text><line x1="667.4140625" x2="983.3671875" y1="362" y2="362" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="993.3671875" y="392.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="993.3671875">利用进程注入技术将 Payload Stage 注入到进程中</tspan></text><line x1="983.3671875" x2="1375.3203125" y1="401" y2="401" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="1400.3203125" y="435.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1400.3203125">启用命名管道</tspan></text><line x1="1375.3203125" x2="1395.3203125" y1="421" y2="421" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="1395.3203125" x2="1395.3203125" y1="421" y2="445" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="1395.3203125" x2="1375.3203125" y1="445" y2="445" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="1043.34375" y="470.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1043.34375">连接命名管道，用于结果及命令的收发</tspan></text><line x1="983.3671875" x2="1375.3203125" y1="479" y2="479" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="1123.7578125" y="509.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1123.7578125">发送 Metadata</tspan></text><line x1="1375.3203125" x2="983.3671875" y1="518" y2="518" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="769.8046875" y="548.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="769.8046875">中继 Metadata</tspan></text><line x1="983.3671875" x2="667.4140625" y1="557" y2="557" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="400.1640625" y="587.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="400.1640625">发送 Metadata</tspan></text><line x1="667.4140625" x2="244.0859375" y1="596" y2="596" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="269.0859375" y="630.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="269.0859375">处理 Metadata</tspan></text><line x1="244.0859375" x2="264.0859375" y1="616" y2="616" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="264.0859375" x2="264.0859375" y1="616" y2="640" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="264.0859375" x2="244.0859375" y1="640" y2="640" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="89.0859375" y="669.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="89.0859375">出现新会话</tspan></text><line x1="64.0859375" x2="84.0859375" y1="655" y2="655" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="84.0859375" x2="84.0859375" y1="655" y2="679" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="84.0859375" x2="64.0859375" y1="679" y2="679" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="122.0859375" y="704.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="122.0859375">下发任务</tspan></text><line x1="64.0859375" x2="244.0859375" y1="713" y2="713" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="399.75" y="743.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="399.75">发送所下发任务</tspan></text><line x1="244.0859375" x2="667.4140625" y1="752" y2="752" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="777.390625" y="782.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="777.390625">中继下发任务</tspan></text><line x1="667.4140625" x2="983.3671875" y1="791" y2="791" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="1131.34375" y="821.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1131.34375">发送下发任务</tspan></text><line x1="983.3671875" x2="1375.3203125" y1="830" y2="830" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="1400.3203125" y="864.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1400.3203125">处理任务</tspan></text><line x1="1375.3203125" x2="1395.3203125" y1="850" y2="850" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="1395.3203125" x2="1395.3203125" y1="850" y2="874" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="1395.3203125" x2="1375.3203125" y1="874" y2="874" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="1115.34375" y="899.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1115.34375">返回任务处理结果</tspan></text><line x1="1375.3203125" x2="983.3671875" y1="908" y2="908" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="745.390625" y="938.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="745.390625">中继返回任务处理结果</tspan></text><line x1="983.3671875" x2="667.4140625" y1="947" y2="947" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="375.75" y="977.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="375.75">发送返回任务处理结果</tspan></text><line x1="667.4140625" x2="244.0859375" y1="986" y2="986" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="74.0859375" y="1016.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="74.0859375">处理返回结果，并显示</tspan></text><line x1="244.0859375" x2="64.0859375" y1="1025" y2="1025" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="687.703125" y="1055.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="687.703125">退出请求</tspan></text><line x1="64.0859375" x2="1375.3203125" y1="1064" y2="1064" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="1400.3203125" y="1098.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1400.3203125">退出</tspan></text><line x1="1375.3203125" x2="1395.3203125" y1="1084" y2="1084" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="1395.3203125" x2="1395.3203125" y1="1084" y2="1108" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="1395.3203125" x2="1375.3203125" y1="1108" y2="1108" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="1115.34375" y="1133.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1115.34375">命名管道读取出错</tspan></text><line x1="983.3671875" x2="1375.3203125" y1="1142" y2="1142" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="705.390625" y="1172.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="705.390625">反馈命名管道读取出错，会话退出</tspan></text><line x1="983.3671875" x2="667.4140625" y1="1181" y2="1181" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="423.75" y="1211.5" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="423.75">断开连接</tspan></text><line x1="667.4140625" x2="244.0859375" y1="1220" y2="1220" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g></svg>