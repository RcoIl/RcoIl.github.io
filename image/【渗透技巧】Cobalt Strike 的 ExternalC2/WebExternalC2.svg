<?xml version="1.0" encoding="utf-8" standalone="no"?><!DOCTYPE svg PUBLIC "-//W3C//DTD SVG 20010904//EN" "http://www.w3.org/TR/2001/REC-SVG-20010904/DTD/svg10.dtd"><svg xmlns="http://www.w3.org/2000/svg" width="2733" height="1215" xmlns:xlink="http://www.w3.org/1999/xlink"><source><![CDATA[Title: Cobalt Strike 特殊的 External C2 处理

Teamserver-->External C2: 
External C2-->Controller: 
Controller-->Client (Web): 
Client (Web)-->Client (EXE): 
Client (EXE)-->SMB Beacon: 
External C2->External C2: 启用 externalc2_start(ip,port)
Controller-->>External C2: Socket 连接 C2，并发送配置（Pipename:rcoil）进行请求 Payload Stage
External C2-->>Controller: 发送 Payload Stage
Controller-->>Client (EXE): 接收 Payload Stage，并另存档，用于目标机上进程注入的 Shellcode 部分
Client (EXE)-->>SMB Beacon: 使用进程注入，将 Shellcode 进行注入
SMB Beacon->SMB Beacon: 启用命名管道 rcoil
Client (EXE)-->>SMB Beacon: 连接命名管道 rcoil，做持久连接，防止 SMB Beacon 误以为断线，并获取 metadata
Client (EXE)->Client (EXE): 创建新的命名管道 readrcoil 和 writercoil，将 metadata 写入 readrcoil，等待 Client (Web) 连接
Client (Web)-->>Client (EXE): 连接命名管道 readrcoil，等待 Controller 下发读写指令
Controller-->>Client (Web): 下发读指令
Client (Web)-->>Client (EXE): 读取 readrcoil，获取 metadata
Client (EXE)-->>Client (Web): 将读写所需 metadata 通过命名管道 readrcoil 进行反馈
Client (Web)-->>Controller: 反馈读执行结果
Controller-->>External C2: 将获取到的 metadata 发送给 External C2 服务器
Teamserver->Teamserver: 出现上线机器
Teamserver-->>External C2: 下发任务
External C2-->>Controller: 发送所下发任务指令
Controller-->>Client (Web): 将任务指令发送
Client (Web)-->>Client (EXE): 将下发的任务执行写入 writercoil
Client (EXE)-->>SMB Beacon: 将 writercoil 的内容转发至 rcoil
SMB Beacon->SMB Beacon: 执行指令 
SMB Beacon-->>Client (EXE): 通过 rcoil 将指令结果进行反馈
Client (EXE)->Client (EXE): 将指令结果写入 readrcoil
Client (Web)-->>Client (EXE): 等待 Controller 下发读指令，读取 readrcoil 获取指令结果
Controller-->>Client (Web): 以轮询的方式连接 Client (Web)]]></source><desc>Cobalt Strike 特殊的 External C2 处理</desc><defs><marker viewBox="0 0 5 5" markerWidth="5" markerHeight="5" orient="auto" refX="5" refY="2.5" id="markerArrowBlock"><path d="M 0 0 L 5 2.5 L 0 5 z"></path></marker><marker viewBox="0 0 9.6 16" markerWidth="4" markerHeight="16" orient="auto" refX="9.6" refY="8" id="markerArrowOpen"><path d="M 9.6,8 1.92,16 0,13.7 5.76,8 0,2.286 1.92,0 9.6,8 z"></path></marker></defs><g class="title"><rect x="10" y="10" width="349.03125" height="28" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="15" y="30" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="15">Cobalt Strike 特殊的 External C2 处理</tspan></text></g><g class="actor"><rect x="10" y="48" width="115.96875" height="38" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="20" y="73" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="20">Teamserver</tspan></text></g><g class="actor"><rect x="10" y="1157.140625" width="115.96875" height="38" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="20" y="1182.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="20">Teamserver</tspan></text></g><line x1="67.984375" x2="67.984375" y1="86" y2="1157.140625" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="145.96875" y="48" width="125.5625" height="38" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="155.96875" y="73" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="155.96875">External C2</tspan></text></g><g class="actor"><rect x="145.96875" y="1157.140625" width="125.5625" height="38" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="155.96875" y="1182.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="155.96875">External C2</tspan></text></g><line x1="208.75" x2="208.75" y1="86" y2="1157.140625" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="759.265625" y="48" width="115.96875" height="38" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="769.265625" y="73" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="769.265625">Controller</tspan></text></g><g class="actor"><rect x="759.265625" y="1157.140625" width="115.96875" height="38" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="769.265625" y="1182.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="769.265625">Controller</tspan></text></g><line x1="817.25" x2="817.25" y1="86" y2="1157.140625" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="1022.34375" y="48" width="135.15625" height="38" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="1032.34375" y="73" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1032.34375">Client (Web)</tspan></text></g><g class="actor"><rect x="1022.34375" y="1157.140625" width="135.15625" height="38" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="1032.34375" y="1182.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1032.34375">Client (Web)</tspan></text></g><line x1="1089.921875" x2="1089.921875" y1="86" y2="1157.140625" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="1518.890625" y="48" width="135.15625" height="38" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="1528.890625" y="73" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1528.890625">Client (EXE)</tspan></text></g><g class="actor"><rect x="1518.890625" y="1157.140625" width="135.15625" height="38" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="1528.890625" y="1182.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1528.890625">Client (EXE)</tspan></text></g><line x1="1586.46875" x2="1586.46875" y1="86" y2="1157.140625" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="actor"><rect x="2393.65625" y="48" width="115.96875" height="38" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="2403.65625" y="73" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="2403.65625">SMB Beacon</tspan></text></g><g class="actor"><rect x="2393.65625" y="1157.140625" width="115.96875" height="38" stroke="#000000" fill="#ffffff" style="stroke-width: 2;"></rect><text x="2403.65625" y="1182.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="2403.65625">SMB Beacon</tspan></text></g><line x1="2451.640625" x2="2451.640625" y1="86" y2="1157.140625" stroke="#000000" fill="none" style="stroke-width: 2;"></line><g class="signal"><text x="138.3671875" y="111" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="138.3671875"></tspan></text><line x1="67.984375" x2="208.75" y1="106" y2="106" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="513" y="131" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="513"></tspan></text><line x1="208.75" x2="817.25" y1="126" y2="126" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="953.5859375" y="151" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="953.5859375"></tspan></text><line x1="817.25" x2="1089.921875" y1="146" y2="146" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="1338.1953125" y="171" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1338.1953125"></tspan></text><line x1="1089.921875" x2="1586.46875" y1="166" y2="166" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="2019.0546875" y="191" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="2019.0546875"></tspan></text><line x1="1586.46875" x2="2451.640625" y1="186" y2="186" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="233.75" y="220.2421875" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="233.75">启用 externalc2_start(ip,port)</tspan></text><line x1="208.75" x2="228.75" y1="206" y2="206" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="228.75" x2="228.75" y1="206" y2="229.484375" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="228.75" x2="208.75" y1="229.484375" y2="229.484375" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="218.75" y="255.375" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="218.75">Socket 连接 C2，并发送配置（Pipename:rcoil）进行请求 Payload Stage</tspan></text><line x1="817.25" x2="208.75" y1="262.703125" y2="262.703125" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="429.8359375" y="293.59375" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="429.8359375">发送 Payload Stage</tspan></text><line x1="208.75" x2="817.25" y1="300.921875" y2="300.921875" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="914.015625" y="331.8125" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="914.015625">接收 Payload Stage，并另存档，用于目标机上进程注入的 Shellcode 部分</tspan></text><line x1="817.25" x2="1586.46875" y1="339.140625" y2="339.140625" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="1870.3359375" y="370.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1870.3359375">使用进程注入，将 Shellcode 进行注入</tspan></text><line x1="1586.46875" x2="2451.640625" y1="377.140625" y2="377.140625" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="2476.640625" y="411.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="2476.640625">启用命名管道 rcoil</tspan></text><line x1="2451.640625" x2="2471.640625" y1="397.140625" y2="397.140625" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="2471.640625" x2="2471.640625" y1="397.140625" y2="420.140625" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="2471.640625" x2="2451.640625" y1="420.140625" y2="420.140625" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="1697.6328125" y="446.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1697.6328125">连接命名管道 rcoil，做持久连接，防止 SMB Beacon 误以为断线，并获取 metadata</tspan></text><line x1="1586.46875" x2="2451.640625" y1="453.140625" y2="453.140625" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="1611.46875" y="487.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1611.46875">创建新的命名管道 readrcoil 和 writercoil，将 metadata 写入 readrcoil，等待 Client (Web) 连接</tspan></text><line x1="1586.46875" x2="1606.46875" y1="473.140625" y2="473.140625" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="1606.46875" x2="1606.46875" y1="473.140625" y2="496.140625" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="1606.46875" x2="1586.46875" y1="496.140625" y2="496.140625" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="1112.71875" y="522.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1112.71875">连接命名管道 readrcoil，等待 Controller 下发读写指令</tspan></text><line x1="1089.921875" x2="1586.46875" y1="529.140625" y2="529.140625" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="913.609375" y="560.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="913.609375">下发读指令</tspan></text><line x1="817.25" x2="1089.921875" y1="567.140625" y2="567.140625" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="1207.0625" y="598.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1207.0625">读取 readrcoil，获取 metadata</tspan></text><line x1="1089.921875" x2="1586.46875" y1="605.140625" y2="605.140625" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="1117.515625" y="636.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1117.515625">将读写所需 metadata 通过命名管道 readrcoil 进行反馈</tspan></text><line x1="1586.46875" x2="1089.921875" y1="643.140625" y2="643.140625" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="897.6171875" y="674.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="897.6171875">反馈读执行结果</tspan></text><line x1="1089.921875" x2="817.25" y1="681.140625" y2="681.140625" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="314.703125" y="712.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="314.703125">将获取到的 metadata 发送给 External C2 服务器</tspan></text><line x1="817.25" x2="208.75" y1="719.140625" y2="719.140625" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="92.984375" y="753.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="92.984375">出现上线机器</tspan></text><line x1="67.984375" x2="87.984375" y1="739.140625" y2="739.140625" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="87.984375" x2="87.984375" y1="739.140625" y2="762.140625" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="87.984375" x2="67.984375" y1="762.140625" y2="762.140625" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="106.3828125" y="788.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="106.3828125">下发任务</tspan></text><line x1="67.984375" x2="208.75" y1="795.140625" y2="795.140625" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="441.0390625" y="826.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="441.0390625">发送所下发任务指令</tspan></text><line x1="208.75" x2="817.25" y1="833.140625" y2="833.140625" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="897.6171875" y="864.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="897.6171875">将任务指令发送</tspan></text><line x1="817.25" x2="1089.921875" y1="871.140625" y2="871.140625" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="1205.46875" y="902.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1205.46875">将下发的任务执行写入 writercoil</tspan></text><line x1="1089.921875" x2="1586.46875" y1="909.140625" y2="909.140625" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="1876.7265625" y="940.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1876.7265625">将 writercoil 的内容转发至 rcoil</tspan></text><line x1="1586.46875" x2="2451.640625" y1="947.140625" y2="947.140625" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="2476.640625" y="981.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="2476.640625">执行指令</tspan></text><line x1="2451.640625" x2="2471.640625" y1="967.140625" y2="967.140625" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="2471.640625" x2="2471.640625" y1="967.140625" y2="990.140625" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="2471.640625" x2="2451.640625" y1="990.140625" y2="990.140625" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="1897.5234375" y="1016.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1897.5234375">通过 rcoil 将指令结果进行反馈</tspan></text><line x1="2451.640625" x2="1586.46875" y1="1023.140625" y2="1023.140625" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="1611.46875" y="1057.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1611.46875">将指令结果写入 readrcoil</tspan></text><line x1="1586.46875" x2="1606.46875" y1="1043.140625" y2="1043.140625" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="1606.46875" x2="1606.46875" y1="1043.140625" y2="1066.140625" stroke="#000000" fill="none" style="stroke-width: 2;"></line><line x1="1606.46875" x2="1586.46875" y1="1066.140625" y2="1066.140625" stroke="#000000" fill="none" style="stroke-width: 2; marker-end: url(&quot;#markerArrowBlock&quot;);"></line></g><g class="signal"><text x="1099.921875" y="1092.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="1099.921875">等待 Controller 下发读指令，读取 readrcoil 获取指令结果</tspan></text><line x1="1089.921875" x2="1586.46875" y1="1099.140625" y2="1099.140625" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g><g class="signal"><text x="827.25" y="1130.140625" style="font-size: 16px; font-family: &quot;Andale Mono&quot;, monospace;"><tspan x="827.25">以轮询的方式连接 Client (Web)</tspan></text><line x1="817.25" x2="1089.921875" y1="1137.140625" y2="1137.140625" stroke="#000000" fill="none" style="stroke-width: 2; stroke-dasharray: 6, 2; marker-end: url(&quot;#markerArrowOpen&quot;);"></line></g></svg>